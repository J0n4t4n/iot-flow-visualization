<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <style type="text/css">
        #mynetwork {
            width: 600px;
            height: 400px;
            border: 1px solid lightgray;
        }
    </style>
</head>
<body>

<input type="button" onclick="addNode()" value="add node" />
<div id="mynetwork"></div>

<script type="text/javascript">
    var nodes;

    function startNetwork() {
        client = new Paho.MQTT.Client("stable201.container.demo.local", 10110, "visjs-visualizer");

        client.onMessageArrived = onMessageArrived;

        client.connect({
            userName: "ezmeral",
            password: "NMH4JieRkWb!LH79KmZW6sNwWJ!E9X",
            onSuccess: onConnect,
        })

        function onConnect() {
            console.log("onConnect");
            client.subscribe("homie/+/$name");
            client.subscribe("homie/+/integer/integer");
        }

        // called when a message arrives
        function onMessageArrived(message) {
            if (message.destinationName.endsWith("$name")) {
                console.log("This is a name: " + message.payloadString)
                var newId = (Math.random() * 1e7).toString(32);
                nodes.update({id: newId, label: message.payloadString, group: 'sensor'})
                edges.update({from: newId, to: 0})
            } else {
                console.log("onMessageArrived: " + message.destinationName + " " + message.payloadString);
            }
        }

        // create an array with nodes
        nodes = new vis.DataSet([
            /*{id: 1, label: 'Weight Cell 1', group: "sensor"},
            {id: 2, label: 'Weight Cell 2', group: "sensor"},
            {id: 3, label: 'Weight Cell 3', group: "sensor"},
            {id: 4, label: 'Weight Cell 4', group: "sensor"},
            {id: 5, label: 'Weight Cell 5', group: "sensor"},
            {id: 6, label: 'Weight Cell 2', group: "sensor"},
            {id: 7, label: 'Weight Cell 3', group: "sensor"},
            {id: 8, label: 'Weight Cell 4', group: "sensor"},
            {id: 9, label: 'Weight Cell 5', group: "sensor"},*/
            {id: 0, label: 'Raspberry Pi', group: "device"},
            {id: 10, label: 'Mosquitto', group: "software"}
        ]);

        // create an array with edges
        var edges = new vis.DataSet([
            /*{from: 0, to: 1, label: "Error", length: 200, color: "#C5000B"},
            {from: 0, to: 2},
            {from: 0, to: 3},
            {from: 0, to: 4},
            {from: 0, to: 5},
            {from: 0, to: 6},
            {from: 0, to: 7},
            {from: 0, to: 8},
            {from: 0, to: 9},*/
            {from: 0, to: 10, length: 300}
        ]);

        // create a network
        var container = document.getElementById('mynetwork');

        // provide the data in the vis format
        var data = {
            nodes: nodes,
            edges: edges
        };
        var options = {
            groups: {
                sensor: {
                    shape: "dot",
                    color: "#2B7CE9"
                },
                device: {
                    shape: "square",
                    color: "#109618"
                },
                software: {
                    color: "#999999"
                }
            }
        };

        // initialize your network!
        var network = new vis.Network(container, data, options);
    }

    function addNode() {
        var newId = (Math.random() * 1e7).toString(32);
        nodes.add({id: newId, label: "I'm new!" });
    }

    startNetwork()
</script>
</body>
</html>
