<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <style type="text/css">
        #mynetwork {

        }
    </style>
</head>
<body>

<div id="mynetwork"></div>

<script type="text/javascript">
    var nodes;
    const hostMap = new Map();

    async function sha256(message) {
        // Taken from: https://stackoverflow.com/a/48161723
        const msgBuffer = new TextEncoder().encode(message);

        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);

        const hashArray = Array.from(new Uint8Array(hashBuffer));

        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex;
    }

    function startNetwork() {
        client = new Paho.MQTT.Client("stable201.container.demo.local", 10110, "visjs-visualizer");

        client.onMessageArrived = onMessageArrived;

        client.connect({
            userName: "ezmeral",
            password: "NMH4JieRkWb!LH79KmZW6sNwWJ!E9X",
            onSuccess: onConnect,
        })

        function onConnect() {
            console.log("onConnect");
            client.subscribe("homie/+/$mac");
            client.subscribe("homie/+/$name");
            client.subscribe("homie/+/$state");
            client.subscribe("homie/+/integer/integer");
        }

        // called when a message arrives
        async function onMessageArrived(message) {
            var newId = (Math.random() * 1e7).toString(32);

            let sensorId = message.destinationName.match(/homie\/([\w-]*)\//)[1]
            let sensorIdHash = await sha256(sensorId)

            switch (true) {
                case message.destinationName.endsWith("$name"):
                    console.log("This is a name: " + message.payloadString)

                    // Create new node for the sensor
                    nodes.update({id: sensorIdHash, label: message.payloadString, group: 'sensor'})
                    // Find host that the sensor is connected to
                    let responsibleHost = hostMap.get(sensorIdHash)
                    // Create host -> sensor connection
                    edges.update({id: sensorIdHash, from: sensorIdHash, to: responsibleHost})
                    break;

                case message.destinationName.endsWith("$mac"):
                    console.log("This is a MAC: " + message.payloadString)

                    // Hash the MAC adress to create a hostId
                    var hostIdHash = await sha256(message.payloadString)
                    // Create new node for the host
                    nodes.update({id: hostIdHash, label: message.payloadString.toUpperCase(), group: 'device'})
                    // Connect host to mosquitto broker
                    edges.update({id: hostIdHash, from: hostIdHash, to: 0})

                    // Save sensor -> host mapping
                    hostMap.set(sensorIdHash, hostIdHash)

                    // Search and Fix edges that couldn't be connected, due to the
                    // $name message arriving earlier than the $mac message
                    edges.get({
                    filter: function(item) {
                        return item.to == null && item.from == sensorIdHash;
                    }
                    }).forEach(item => edges.updateOnly({id: item.id, to: hostIdHash}))
                    break;

                case message.destinationName.endsWith("$state"):
                    console.log("This is a state change: " + message.payloadString)

                    switch (message.payloadString) {
                        // Colors: https://coolors.co/4c5454-ff715b-ffffff-1ea896-523f38
                        case "ready":
                            console.log("Ready")
                            edges.updateOnly({id: sensorIdHash, color: "#1EA896", label: " "})
                            break
                        case "lost":
                            console.log("Lost")
                            edges.updateOnly({id: sensorIdHash, color: "#FF715B", label: "Connection lost"})
                            break
                        default:
                            console.log("Unknown state")
                            edges.updateOnly({id: sensorIdHash, color: "#523F38", label: "Unknown error"})
                            break
                    }
                    break;

                default:
                    console.log("onMessageArrived: " + message.destinationName + " " + message.payloadString);
            }
        }

        // create an array with nodes
        nodes = new vis.DataSet([
            {id: 0, label: 'Mosquitto', group: "software"}
        ]);

        // create an array with edges
        var edges = new vis.DataSet([
            /*{from: 0, to: 1, label: "Error", length: 200, color: "#C5000B"}*/
        ]);

        // create a network
        var container = document.getElementById('mynetwork');

        var x = -container.clientWidth / 2;
        var y = -container.clientHeight / 2;
        var step = 70;

        nodes.update({
            id: 1000,
            x: x,
            y: y,
            label: "Sensor",
            group: "sensor",
            value: 1,
            fixed: true,
            physics: false,
        })
        nodes.update({
            id: 1001,
            x: x,
            y: y + step,
            label: "Device",
            group: "device",
            value: 2,
            fixed: true,
            physics: false,
        })
        nodes.update({
            id: 1002,
            x: x,
            y: y + 2*step,
            label: "Software",
            group: "software",
            value: 3,
            fixed: true,
            physics: false,
        })

        // provide the data in the vis format
        var data = {
            nodes: nodes,
            edges: edges
        };
        var options = {
            groups: {
                // Colors: https://coolors.co/320e3b-e56399-7f96ff-a6cfd5-dbfcff
                sensor: {
                    shape: "dot",
                    color: "#A6CFD5"
                },
                device: {
                    shape: "square",
                    color: "#7F96FF"
                },
                software: {
                    color: "#E56399"
                }
            }
        };

        // initialize your network!
        var network = new vis.Network(container, data, options);
    }

    startNetwork()
</script>
</body>
</html>
